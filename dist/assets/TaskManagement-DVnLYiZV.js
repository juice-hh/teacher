import{o as f,c as v,b as e,w as l,D as C,S as B,r as p,e as be,a as _,f as R,U as ve,h as r,q as g,F as T,p as F,j as w,K as G,L as ke,M as Ve,O as h,N as H,y as Ie}from"./index-BQs85f6M.js";import{u as Ce}from"./indicator-ax52G24x.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const we={class:"task-management"},he={class:"card-header"},qe={class:"search-bar"},xe={key:0},De={class:"indicator-score"},ze={key:1},Ue={class:"pagination"},Be={class:"indicator-selector"},$e={class:"indicator-option"},Se={class:"form-tip"},Te={key:0,class:"linked-rule-details",style:{"margin-top":"12px",width:"100%"}},Fe={class:"participant-count"},Ee={__name:"TaskManagement",setup(Ne){const J=be(),E=Ce(),{primaryIndicators:z,getSecondaryByPrimary:N}=E,V=C(!1),q=C(!1),U=C(!1),j=C(null),$=C(null),k=B({name:"",type:"",status:""}),I=B({page:1,size:10,total:0}),n=B({name:"",period:"",dateRange:null,primaryIndicatorIds:[],participants:[],description:""}),M=Ie(()=>{if(!n.primaryIndicatorIds||n.primaryIndicatorIds.length===0)return[];const o=[];return n.primaryIndicatorIds.forEach(t=>{const d=z.value.find(i=>i.id===t),m=N(t);d&&m&&m.forEach(i=>{o.push({...i,primaryName:d.name})})}),o}),s=B({name:"",primaryId:null,score:5,scoringRule:"",materialRequirement:"",responsibleBody:""}),W={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],type:[{required:!0,message:"请选择任务类型",trigger:"change"}],period:[{required:!0,message:"请选择评价周期",trigger:"change"}],dateRange:[{required:!0,message:"请选择起止时间",trigger:"change"}]},X={name:[{required:!0,message:"请输入指标名称",trigger:"blur"}],primaryId:[{required:!0,message:"请选择所属一级指标",trigger:"change"}],score:[{required:!0,message:"请输入分值",trigger:"blur"}],scoringRule:[{required:!0,message:"请输入评分规则",trigger:"blur"}],materialRequirement:[{required:!0,message:"请输入材料要求",trigger:"blur"}],responsibleBody:[{required:!0,message:"请输入责任部门",trigger:"blur"}]},O=C([{id:1,name:"2024年度教师自评",type:"self",period:"2024年度",startDate:"2024-03-01",endDate:"2024-03-31",indicators:[{id:1,name:"备课充分",score:5,type:"secondary"},{id:5,name:"教学方法创新",score:8,type:"secondary"}],participantCount:128,completedCount:96,completionRate:75,status:"进行中"},{id:2,name:"第一季度同行评审",type:"peer",period:"2024年春季学期",startDate:"2024-04-01",endDate:"2024-04-30",indicators:[],participantCount:128,completedCount:0,completionRate:0,status:"未开始"},{id:3,name:"教学态度专项评价",type:"comprehensive",period:"2023年度",startDate:"2024-02-01",endDate:"2024-02-28",indicators:[{id:1,name:"备课充分",score:5,type:"secondary"},{id:2,name:"课堂管理",score:5,type:"secondary"},{id:3,name:"作业批改",score:5,type:"secondary"}],participantCount:128,completedCount:128,completionRate:100,status:"已结束"}]);I.total=O.value.length;function Y(o){return{self:"自我评价",peer:"同行评审",comprehensive:"综合评价"}[o]||o}function Z(o){return{self:"primary",peer:"success",comprehensive:"warning"}[o]||"info"}function ee(o){return{未开始:"info",进行中:"primary",已结束:"success"}[o]||"info"}function te(o){return o>=80?"success":o>=50?"warning":"danger"}function ae(){h.success("查询成功")}function le(){Object.assign(k,{name:"",type:"",status:""})}function oe(){U.value=!1,Object.assign(n,{name:"",period:"",dateRange:null,primaryIndicatorIds:[],participants:[],description:""}),V.value=!0}function ne(o){U.value=!0;const t=new Set;o.indicators&&o.indicators.forEach(d=>{const m=z.value.find(i=>N(i.id).some(y=>y.id===d.id));m&&t.add(m.id)}),Object.assign(n,{...o,dateRange:[o.startDate,o.endDate],primaryIndicatorIds:Array.from(t)}),V.value=!0}function P(o){J.push(`/admin/task-detail/${o.id}`)}function re(){var o;(o=j.value)==null||o.validate(t=>{if(t){const d={...n,startDate:n.dateRange[0],endDate:n.dateRange[1],indicators:M.value.map(m=>({id:m.id,name:m.name,score:m.score,type:"secondary"}))};console.log("保存任务:",d),V.value=!1,h.success(U.value?"更新成功":"添加成功")}})}function ie(o){H.confirm(`确定要发布任务「${o.name}」吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{o.status="进行中",h.success("任务发布成功")})}function se(o){H.confirm(`确定要删除任务「${o.name}」吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{h.success("删除成功")})}function de(){h.info("打开人员选择器")}function ue(){q.value=!0}function Q(){var o;(o=$.value)==null||o.clearValidate(),Object.assign(s,{name:"",primaryId:null,score:5,scoringRule:"",materialRequirement:"",responsibleBody:""})}function pe(){var o;(o=$.value)==null||o.validate(t=>{if(t){const d={id:Date.now(),primaryId:s.primaryId,name:s.name,score:s.score,scoringRule:s.scoringRule,materialRequirement:s.materialRequirement,responsibleBody:s.responsibleBody};E.addSecondaryIndicator(d),n.primaryIndicatorIds||(n.primaryIndicatorIds=[]),n.primaryIndicatorIds.includes(d.primaryId)||n.primaryIndicatorIds.push(d.primaryId),q.value=!1,h.success("指标创建成功并已自动关联所在一级指标"),Q()}})}return(o,t)=>{const d=p("el-button"),m=p("el-input"),i=p("el-form-item"),y=p("el-option"),x=p("el-select"),S=p("el-form"),D=p("el-link"),c=p("el-table-column"),b=p("el-tag"),me=p("el-popover"),A=p("el-divider"),L=p("el-table"),ce=p("el-pagination"),fe=p("el-card"),ye=p("el-date-picker"),ge=p("el-icon"),K=p("el-dialog"),_e=p("el-input-number");return f(),v("div",we,[e(fe,{class:"page-card",shadow:"hover"},{header:l(()=>[_("div",he,[t[21]||(t[21]=_("span",{class:"card-title"},"评价任务管理",-1)),e(d,{type:"primary",icon:R(G),onClick:oe},{default:l(()=>[...t[20]||(t[20]=[r(" 新增任务 ",-1)])]),_:1},8,["icon"])])]),default:l(()=>[_("div",qe,[e(S,{inline:!0},{default:l(()=>[e(i,{label:"任务名称"},{default:l(()=>[e(m,{modelValue:k.name,"onUpdate:modelValue":t[0]||(t[0]=a=>k.name=a),placeholder:"请输入任务名称",clearable:""},null,8,["modelValue"])]),_:1}),e(i,{label:"任务类型"},{default:l(()=>[e(x,{modelValue:k.type,"onUpdate:modelValue":t[1]||(t[1]=a=>k.type=a),placeholder:"请选择",clearable:""},{default:l(()=>[e(y,{label:"自我评价",value:"self"}),e(y,{label:"同行评审",value:"peer"}),e(y,{label:"综合评价",value:"comprehensive"})]),_:1},8,["modelValue"])]),_:1}),e(i,{label:"状态"},{default:l(()=>[e(x,{modelValue:k.status,"onUpdate:modelValue":t[2]||(t[2]=a=>k.status=a),placeholder:"请选择",clearable:""},{default:l(()=>[e(y,{label:"未开始",value:"未开始"}),e(y,{label:"进行中",value:"进行中"}),e(y,{label:"已结束",value:"已结束"})]),_:1},8,["modelValue"])]),_:1}),e(i,null,{default:l(()=>[e(d,{type:"primary",icon:R(ve),onClick:ae},{default:l(()=>[...t[22]||(t[22]=[r("查询",-1)])]),_:1},8,["icon"]),e(d,{onClick:le},{default:l(()=>[...t[23]||(t[23]=[r("重置",-1)])]),_:1})]),_:1})]),_:1})]),e(L,{data:O.value,style:{width:"100%"}},{default:l(()=>[e(c,{prop:"name",label:"任务名称",width:"200"},{default:l(({row:a})=>[e(D,{type:"primary",underline:!1,onClick:u=>P(a)},{default:l(()=>[r(g(a.name),1)]),_:2},1032,["onClick"])]),_:1}),e(c,{prop:"type",label:"任务类型",width:"120"},{default:l(({row:a})=>[e(b,{type:Z(a.type),size:"small"},{default:l(()=>[r(g(Y(a.type)),1)]),_:2},1032,["type"])]),_:1}),e(c,{prop:"period",label:"评价周期",width:"120"}),e(c,{prop:"startDate",label:"开始日期",width:"120"}),e(c,{prop:"endDate",label:"结束日期",width:"120"}),e(c,{label:"绑定指标",width:"200"},{default:l(({row:a})=>[e(me,{placement:"top",width:300,trigger:"hover"},{reference:l(()=>[a.indicators&&a.indicators.length>0?(f(),w(b,{key:0,type:"info",size:"small"},{default:l(()=>[r(" 已绑定 "+g(a.indicators.length)+" 个指标 ",1)]),_:2},1024)):(f(),w(b,{key:1,type:"info",size:"small",effect:"plain"},{default:l(()=>[...t[24]||(t[24]=[r("未绑定",-1)])]),_:1}))]),default:l(()=>[a.indicators&&a.indicators.length>0?(f(),v("div",xe,[(f(!0),v(T,null,F(a.indicators,u=>(f(),v("div",{key:u.id,class:"indicator-item"},[e(b,{size:"small",type:u.type==="primary"?"primary":"warning"},{default:l(()=>[r(g(u.name),1)]),_:2},1032,["type"]),_("span",De,g(u.score)+"分",1)]))),128))])):(f(),v("div",ze,"该任务未绑定任何指标"))]),_:2},1024)]),_:1}),e(c,{prop:"participantCount",label:"参与人数",width:"100"}),e(c,{prop:"completedCount",label:"完成人数",width:"100"}),e(c,{label:"完成率",width:"100"},{default:l(({row:a})=>[e(b,{type:te(a.completionRate),size:"small"},{default:l(()=>[r(g(a.completionRate)+"% ",1)]),_:2},1032,["type"])]),_:1}),e(c,{prop:"status",label:"状态",width:"100"},{default:l(({row:a})=>[e(b,{type:ee(a.status),size:"small"},{default:l(()=>[r(g(a.status),1)]),_:2},1032,["type"])]),_:1}),e(c,{label:"操作",width:"220",fixed:"right"},{default:l(({row:a})=>[e(D,{type:"primary",underline:!1,onClick:u=>P(a)},{default:l(()=>[...t[25]||(t[25]=[r("查看详情",-1)])]),_:1},8,["onClick"]),e(A,{direction:"vertical"}),e(D,{type:"primary",underline:!1,onClick:u=>ne(a)},{default:l(()=>[...t[26]||(t[26]=[r("编辑",-1)])]),_:1},8,["onClick"]),e(A,{direction:"vertical"}),a.status==="未开始"?(f(),w(D,{key:0,type:"primary",underline:!1,onClick:u=>ie(a)},{default:l(()=>[...t[27]||(t[27]=[r(" 发布 ",-1)])]),_:1},8,["onClick"])):(f(),w(D,{key:1,type:"danger",underline:!1,onClick:u=>se(a)},{default:l(()=>[...t[28]||(t[28]=[r(" 删除 ",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"]),_("div",Ue,[e(ce,{"current-page":I.page,"onUpdate:currentPage":t[3]||(t[3]=a=>I.page=a),"page-size":I.size,"onUpdate:pageSize":t[4]||(t[4]=a=>I.size=a),"page-sizes":[10,20,50],total:I.total,layout:"total, sizes, prev, pager, next"},null,8,["current-page","page-size","total"])])]),_:1}),e(K,{modelValue:V.value,"onUpdate:modelValue":t[11]||(t[11]=a=>V.value=a),title:U.value?"编辑任务":"新增任务",width:"800px"},{footer:l(()=>[e(d,{onClick:t[10]||(t[10]=a=>V.value=!1)},{default:l(()=>[...t[32]||(t[32]=[r("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:re},{default:l(()=>[...t[33]||(t[33]=[r("确定",-1)])]),_:1})]),default:l(()=>[e(S,{model:n,rules:W,ref_key:"taskFormRef",ref:j,"label-width":"120px"},{default:l(()=>[e(i,{label:"任务名称",prop:"name"},{default:l(()=>[e(m,{modelValue:n.name,"onUpdate:modelValue":t[5]||(t[5]=a=>n.name=a),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),e(i,{label:"评价周期",prop:"period"},{default:l(()=>[e(x,{modelValue:n.period,"onUpdate:modelValue":t[6]||(t[6]=a=>n.period=a),placeholder:"请选择"},{default:l(()=>[e(y,{label:"2024年度",value:"2024年度"}),e(y,{label:"2024年春季学期",value:"2024年春季学期"}),e(y,{label:"2024年秋季学期",value:"2024年秋季学期"})]),_:1},8,["modelValue"])]),_:1}),e(i,{label:"起止时间",prop:"dateRange"},{default:l(()=>[e(ye,{modelValue:n.dateRange,"onUpdate:modelValue":t[7]||(t[7]=a=>n.dateRange=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期"},null,8,["modelValue"])]),_:1}),e(i,{label:"绑定指标",prop:"primaryIndicatorIds"},{default:l(()=>{var a;return[_("div",Be,[e(x,{modelValue:n.primaryIndicatorIds,"onUpdate:modelValue":t[8]||(t[8]=u=>n.primaryIndicatorIds=u),multiple:"",placeholder:"请选择一级评价指标",style:{width:"100%"}},{default:l(()=>[(f(!0),v(T,null,F(R(z),u=>(f(),w(y,{key:u.id,label:`${u.name}（${u.score}分）`,value:u.id},{default:l(()=>[_("div",$e,[_("span",null,g(u.name),1),e(b,{size:"small",type:"primary"},{default:l(()=>[r(g(u.score)+"分",1)]),_:2},1024)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),e(d,{type:"primary",icon:R(G),size:"small",class:"add-indicator-btn",onClick:ue},{default:l(()=>[...t[29]||(t[29]=[r(" 快速创建指标 ",-1)])]),_:1},8,["icon"])]),_("div",Se,[e(ge,null,{default:l(()=>[e(R(ke))]),_:1}),r(" 已选择 "+g(((a=n.primaryIndicatorIds)==null?void 0:a.length)||0)+" 个一级指标 ",1)]),n.primaryIndicatorIds&&n.primaryIndicatorIds.length>0?(f(),v("div",Te,[t[30]||(t[30]=_("div",{class:"linked-rule-title",style:{"font-size":"13px","font-weight":"500","margin-bottom":"8px",color:"#595959"}},"指标明细全览",-1)),e(L,{data:M.value,border:"",size:"small"},{default:l(()=>[e(c,{prop:"primaryName",label:"一级指标",width:"120","show-overflow-tooltip":""}),e(c,{prop:"name",label:"二级指标","min-width":"120","show-overflow-tooltip":""}),e(c,{prop:"score",label:"分值",width:"70"},{default:l(({row:u})=>[e(b,{size:"small",type:"warning"},{default:l(()=>[r(g(u.score)+"分",1)]),_:2},1024)]),_:1}),e(c,{prop:"scoringRule",label:"评分规则","min-width":"150","show-overflow-tooltip":""}),e(c,{prop:"materialRequirement",label:"材料要求","min-width":"150","show-overflow-tooltip":""})]),_:1},8,["data"])])):Ve("",!0)]}),_:1}),e(i,{label:"参与人员"},{default:l(()=>{var a;return[e(d,{onClick:de},{default:l(()=>[...t[31]||(t[31]=[r("选择人员",-1)])]),_:1}),_("span",Fe,"已选择 "+g(((a=n.participants)==null?void 0:a.length)||0)+" 人",1)]}),_:1}),e(i,{label:"任务说明"},{default:l(()=>[e(m,{modelValue:n.description,"onUpdate:modelValue":t[9]||(t[9]=a=>n.description=a),type:"textarea",rows:4,placeholder:"请输入任务说明"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(K,{modelValue:q.value,"onUpdate:modelValue":t[19]||(t[19]=a=>q.value=a),title:"快速创建指标",width:"600px",onClose:Q},{footer:l(()=>[e(d,{onClick:t[18]||(t[18]=a=>q.value=!1)},{default:l(()=>[...t[34]||(t[34]=[r("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:pe},{default:l(()=>[...t[35]||(t[35]=[r("确定并添加",-1)])]),_:1})]),default:l(()=>[e(S,{model:s,rules:X,ref_key:"quickCreateFormRef",ref:$,"label-width":"120px"},{default:l(()=>[e(i,{label:"指标名称",prop:"name"},{default:l(()=>[e(m,{modelValue:s.name,"onUpdate:modelValue":t[12]||(t[12]=a=>s.name=a),placeholder:"请输入指标名称"},null,8,["modelValue"])]),_:1}),e(i,{label:"所属一级指标",prop:"primaryId"},{default:l(()=>[e(x,{modelValue:s.primaryId,"onUpdate:modelValue":t[13]||(t[13]=a=>s.primaryId=a),placeholder:"请选择所属一级指标",style:{width:"100%"}},{default:l(()=>[(f(!0),v(T,null,F(R(z),a=>(f(),w(y,{key:a.id,label:`${a.name}（${a.score}分）`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(i,{label:"分值",prop:"score"},{default:l(()=>[e(_e,{modelValue:s.score,"onUpdate:modelValue":t[14]||(t[14]=a=>s.score=a),min:1,max:50},null,8,["modelValue"])]),_:1}),e(i,{label:"评分规则",prop:"scoringRule"},{default:l(()=>[e(m,{modelValue:s.scoringRule,"onUpdate:modelValue":t[15]||(t[15]=a=>s.scoringRule=a),type:"textarea",rows:3,placeholder:"请输入评分规则"},null,8,["modelValue"])]),_:1}),e(i,{label:"材料要求",prop:"materialRequirement"},{default:l(()=>[e(m,{modelValue:s.materialRequirement,"onUpdate:modelValue":t[16]||(t[16]=a=>s.materialRequirement=a),type:"textarea",rows:2,placeholder:"请输入材料要求"},null,8,["modelValue"])]),_:1}),e(i,{label:"责任部门",prop:"responsibleBody"},{default:l(()=>[e(m,{modelValue:s.responsibleBody,"onUpdate:modelValue":t[17]||(t[17]=a=>s.responsibleBody=a),placeholder:"请输入责任部门"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Pe=Re(Ee,[["__scopeId","data-v-b46e2bb8"]]);export{Pe as default};
